@page
@model RazorPagesMovie.Pages.Order.CreateModel
@{
    ViewData["Title"] = "Оформление заказа";
}

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        @Html.Raw(TempData["SuccessMessage"])
    }

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0">Оформление заказа: @Model.Product?.Name</h2>
            @if (Model.Product?.IdIndivBuyer != null)
            {
                <span class="badge bg-warning">Индивидуальный товар</span>
            }
        </div>
        <div class="card-body">
            <form method="post" id="orderForm" novalidate>
                <input type="hidden" asp-for="ProductId" id="productId" />
                <input type="hidden" asp-for="Price" value="@Model.Product?.Price" id="productPrice" />
                <input type="hidden" id="availableQuantity" value="@Model.Product?.QuantityForSale" />

                <div class="mb-3">
                    <label asp-for="Quantity" class="form-label">
                        Количество товара
                        @if (Model.Product?.IdIndivBuyer == null)
                        {
                            <span class="badge bg-info ms-2">Доступно: @Model.Product?.QuantityForSale шт.</span>
                        }
                    </label>
                    <input type="number" asp-for="Quantity" class="form-control"
                           min="1" max="@(Math.Min(100, Model.Product?.QuantityForSale ?? 100))"
                           required id="quantityInput"
                           oninvalid="this.setCustomValidity('Пожалуйста, введите количество от 1 до @(Math.Min(100, Model.Product?.QuantityForSale ?? 100))')"
                           oninput="this.setCustomValidity('')" />
                    <div class="form-text" id="availabilityMessage">
                        @if (Model.Product?.IdIndivBuyer == null)
                        {
                            <span>Максимально можно заказать: @Math.Min(100, Model.Product?.QuantityForSale ?? 100) шт.</span>
                        }
                        else
                        {
                            <span class="text-warning">Это индивидуальный товар, предназначенный только для вас</span>
                        }
                    </div>
                    <span asp-validation-for="Quantity" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="MethodDelivery" class="form-label">Способ доставки</label>
                    <select asp-for="MethodDelivery" class="form-control" required id="methodDelivery"
                            oninvalid="this.setCustomValidity('Пожалуйста, выберите способ доставки')"
                            oninput="this.setCustomValidity('')">
                        <option value="">Выберите способ доставки</option>
                        <option value="courier">Курьерская доставка</option>
                        <option value="pickup">Самовывоз</option>
                        <option value="mail">Почтовая доставка</option>
                    </select>
                    <span asp-validation-for="MethodDelivery" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="AddressReceiving" class="form-label">Адрес получения товара</label>
                    <textarea asp-for="AddressReceiving" class="form-control" rows="3"
                              required id="addressReceiving"
                              oninvalid="this.setCustomValidity('Пожалуйста, укажите адрес доставки')"
                              oninput="this.setCustomValidity('')"
                              placeholder="Укажите полный адрес для доставки"></textarea>
                    <div class="form-text">
                        Укажите полный адрес для доставки.
                    </div>
                    <span asp-validation-for="AddressReceiving" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Comment" class="form-label">Комментарий к заказу (опционально)</label>
                    <textarea asp-for="Comment" class="form-control" rows="2" id="comment"
                              maxlength="500" placeholder="Максимум 500 символов"></textarea>
                    <div class="form-text">
                        <span id="charCount">0/500</span> символов
                    </div>
                </div>

                <div class="alert alert-info">
                    <h5 class="alert-heading">Итоговая информация</h5>
                    <p><strong>Товар:</strong> @Model.Product?.Name</p>
                    <p><strong>Цена за единицу:</strong> @Model.Product?.Price.ToString("C")</p>
                    <p><strong>Количество:</strong> <span id="displayQuantity">@Model.Quantity</span> шт.</p>
                    <p class="h5"><strong>Итоговая стоимость:</strong> <span id="totalPrice">@Model.TotalPrice.ToString("C")</span></p>
                    <hr>
                    <small class="mb-0">Стоимость доставки будет уточнена продавцом после подтверждения заказа</small>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a asp-page="/Index" class="btn btn-secondary me-md-2">
                        <i class="bi bi-arrow-left"></i> Отмена
                    </a>
                    <button type="submit" class="btn btn-success" id="submitBtn">
                        <i class="bi bi-check-circle"></i> Подтвердить заказ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('orderForm');
            const quantityInput = document.getElementById('quantityInput');
            const priceInput = document.getElementById('productPrice');
            const totalPriceElement = document.getElementById('totalPrice');
            const displayQuantity = document.getElementById('displayQuantity');
            const availableQuantity = parseInt(document.getElementById('availableQuantity').value) || 0;
            const commentTextarea = document.getElementById('comment');
            const charCount = document.getElementById('charCount');
            const submitBtn = document.getElementById('submitBtn');

            // Обновление итоговой цены
            function updateTotalPrice() {
                const quantity = parseInt(quantityInput.value) || 1;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                totalPriceElement.textContent = total.toLocaleString('ru-RU', {
                    style: 'currency',
                    currency: 'RUB'
                });
                displayQuantity.textContent = quantity;
            }

            // Валидация количества
            function validateQuantity() {
                const quantity = parseInt(quantityInput.value) || 0;
                const maxQuantity = Math.min(100, availableQuantity);

                if (quantity > maxQuantity) {
                    quantityInput.setCustomValidity(`Максимально можно заказать ${maxQuantity} шт.`);
                    quantityInput.classList.add('is-invalid');
                    return false;
                } else {
                    quantityInput.setCustomValidity('');
                    quantityInput.classList.remove('is-invalid');
                    return true;
                }
            }

            // Подсчет символов в комментарии
            function updateCharCount() {
                const length = commentTextarea.value.length;
                charCount.textContent = `${length}/500`;
                if (length >= 500) {
                    charCount.classList.add('text-danger');
                } else {
                    charCount.classList.remove('text-danger');
                }
            }

            // Автоматическое закрытие уведомления через 5 секунд
            setTimeout(function() {
                const alert = document.querySelector('.alert-dismissible');
                if (alert) {
                    const closeButton = alert.querySelector('.btn-close');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            }, 5000);

            // События
            quantityInput.addEventListener('input', function() {
                updateTotalPrice();
                validateQuantity();
            });

            quantityInput.addEventListener('change', function() {
                validateQuantity();
            });

            commentTextarea.addEventListener('input', updateCharCount);

            // Проверка перед отправкой
            form.addEventListener('submit', function(e) {
                if (!validateQuantity()) {
                    e.preventDefault();
                    alert(`❌ Ошибка! Максимально можно заказать ${Math.min(100, availableQuantity)} шт. товара.`);
                    quantityInput.focus();
                    quantityInput.select();
                    return false;
                }

                // Блокируем кнопку отправки
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Оформление...';
                return true;
            });

            // Инициализация
            updateTotalPrice();
            updateCharCount();
            validateQuantity();
        });

        // Глобальная функция для установки русских сообщений валидации
        document.addEventListener('invalid', (function() {
            return function(e) {
                e.preventDefault();

                // Устанавливаем русские сообщения для разных типов полей
                if (e.target.validity.valueMissing) {
                    e.target.setCustomValidity('Это поле обязательно для заполнения');
                } else if (e.target.validity.typeMismatch) {
                    e.target.setCustomValidity('Пожалуйста, введите корректное значение');
                } else if (e.target.validity.rangeOverflow) {
                    e.target.setCustomValidity(`Значение не должно превышать ${e.target.max}`);
                } else if (e.target.validity.rangeUnderflow) {
                    e.target.setCustomValidity(`Значение не должно быть меньше ${e.target.min}`);
                } else if (e.target.validity.patternMismatch) {
                    e.target.setCustomValidity('Пожалуйста, введите значение в правильном формате');
                }

                e.target.reportValidity();
            };
        })(), true);

        // Сбрасываем кастомные сообщения при вводе
        document.addEventListener('input', function(e) {
            if (e.target.hasAttribute('required') || e.target.hasAttribute('pattern')) {
                e.target.setCustomValidity('');
            }
        });
    </script>
}